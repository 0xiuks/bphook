.global _hwbp_trampoline_entry
.global _c_hwbp_dispatch
.global _c_suspend_all_hooks
.global _c_resume_all_hooks
.global _BPhook_call_original
.global _patch_exec
.global _patch_exec_resume

.align 4

// HWBP entry trampoline: save cpu_context_t, call _c_hwbp_dispatch(ctx), restore, jump to ctx->resume_pc.
_hwbp_trampoline_entry:
    sub     sp, sp, #0x340
    str     x29, [sp, #0x320]
    str     x30, [sp, #0x328]
    add     x29, sp, #0x320
    stp     x0,  x1,  [sp, #0x000]
    stp     x2,  x3,  [sp, #0x010]
    stp     x4,  x5,  [sp, #0x020]
    stp     x6,  x7,  [sp, #0x030]
    stp     x8,  x9,  [sp, #0x040]
    stp     x10, x11, [sp, #0x050]
    stp     x12, x13, [sp, #0x060]
    stp     x14, x15, [sp, #0x070]
    stp     x16, x17, [sp, #0x080]
    stp     x18, x19, [sp, #0x090]
    stp     x20, x21, [sp, #0x0A0]
    stp     x22, x23, [sp, #0x0B0]
    stp     x24, x25, [sp, #0x0C0]
    stp     x26, x27, [sp, #0x0D0]
    str     x28,      [sp, #0x0E0]
    ldr     x9,  [sp, #0x320]
    str     x9,  [sp, #0x0E8]
    ldr     x10, [sp, #0x328]
    str     x10, [sp, #0x0F0]
    str     x16, [sp, #0x0F8]
    mrs     x9, nzcv
    str     x9, [sp, #0x100]
    stp     q0,  q1,  [sp, #0x110]
    stp     q2,  q3,  [sp, #0x130]
    stp     q4,  q5,  [sp, #0x150]
    stp     q6,  q7,  [sp, #0x170]
    stp     q8,  q9,  [sp, #0x190]
    stp     q10, q11, [sp, #0x1B0]
    stp     q12, q13, [sp, #0x1D0]
    stp     q14, q15, [sp, #0x1F0]
    stp     q16, q17, [sp, #0x210]
    stp     q18, q19, [sp, #0x230]
    stp     q20, q21, [sp, #0x250]
    stp     q22, q23, [sp, #0x270]
    stp     q24, q25, [sp, #0x290]
    stp     q26, q27, [sp, #0x2B0]
    stp     q28, q29, [sp, #0x2D0]
    stp     q30, q31, [sp, #0x2F0]
    ldr     x18, [sp, #0x090]
    mov     x0, sp
    bl      _c_hwbp_dispatch
    ldp     q0,  q1,  [sp, #0x110]
    ldp     q2,  q3,  [sp, #0x130]
    ldp     q4,  q5,  [sp, #0x150]
    ldp     q6,  q7,  [sp, #0x170]
    ldp     q8,  q9,  [sp, #0x190]
    ldp     q10, q11, [sp, #0x1B0]
    ldp     q12, q13, [sp, #0x1D0]
    ldp     q14, q15, [sp, #0x1F0]
    ldp     q16, q17, [sp, #0x210]
    ldp     q18, q19, [sp, #0x230]
    ldp     q20, q21, [sp, #0x250]
    ldp     q22, q23, [sp, #0x270]
    ldp     q24, q25, [sp, #0x290]
    ldp     q26, q27, [sp, #0x2B0]
    ldp     q28, q29, [sp, #0x2D0]
    ldp     q30, q31, [sp, #0x2F0]
    ldp     x0,  x1,  [sp, #0x000]
    ldp     x2,  x3,  [sp, #0x010]
    ldp     x4,  x5,  [sp, #0x020]
    ldp     x6,  x7,  [sp, #0x030]
    ldp     x8,  x9,  [sp, #0x040]
    ldp     x10, x11, [sp, #0x050]
    ldp     x12, x13, [sp, #0x060]
    ldp     x14, x15, [sp, #0x070]
    ldr     x16, [sp, #0x080]
    ldr     x18, [sp, #0x090]
    ldr     x19, [sp, #0x098]
    ldp     x20, x21, [sp, #0x0A0]
    ldp     x22, x23, [sp, #0x0B0]
    ldp     x24, x25, [sp, #0x0C0]
    ldp     x26, x27, [sp, #0x0D0]
    ldr     x28, [sp, #0x0E0]
    ldr     x29, [sp, #0x0E8]
    ldr     x30, [sp, #0x0F0]
    ldr     x17, [sp, #0x100]
    msr     nzcv, x17
    ldr     x17, [sp, #0x108]
    add     sp, sp, #0x340
    br      x17

// BPhook_call_original(ctx): call ctx->x[16] with registers restored from ctx; writes back x0/x1/q0/NZCV.
_BPhook_call_original:
    stp     x29, x30, [sp, #-16]!
    mov     x29, sp
    sub     sp, sp, #0xE0
    stp     x19, x20, [sp, #0x00]
    stp     x21, x22, [sp, #0x10]
    stp     x23, x24, [sp, #0x20]
    stp     x25, x26, [sp, #0x30]
    stp     x27, x28, [sp, #0x40]
    stp     q8,  q9,  [sp, #0x50]
    stp     q10, q11, [sp, #0x70]
    stp     q12, q13, [sp, #0x90]
    stp     q14, q15, [sp, #0xB0]
    mov     x19, x0
    str     x19, [sp, #0xD8]
    ldr     x0, [x19, #0x78]
    str     x0, [sp,  #0xD0]
    bl      _c_suspend_all_hooks
    ldp     q0,  q1,  [x19, #0x110]
    ldp     q2,  q3,  [x19, #0x130]
    ldp     q4,  q5,  [x19, #0x150]
    ldp     q6,  q7,  [x19, #0x170]
    ldp     q8,  q9,  [x19, #0x190]
    ldp     q10, q11, [x19, #0x1B0]
    ldp     q12, q13, [x19, #0x1D0]
    ldp     q14, q15, [x19, #0x1F0]
    ldp     x0,  x1,  [x19, #0x000]
    ldp     x2,  x3,  [x19, #0x010]
    ldp     x4,  x5,  [x19, #0x020]
    ldp     x6,  x7,  [x19, #0x030]
    ldp     x8,  x9,  [x19, #0x040]
    ldp     x10, x11, [x19, #0x050]
    ldp     x12, x13, [x19, #0x060]
    ldp     x14, x15, [x19, #0x070]
    ldr     x16,      [x19, #0x080]
    ldr     x18,      [x19, #0x090]
    ldp     x20, x21, [x19, #0x0A0]
    ldp     x22, x23, [x19, #0x0B0]
    ldp     x24, x25, [x19, #0x0C0]
    ldp     x26, x27, [x19, #0x0D0]
    ldr     x28,      [x19, #0x0E0]
    ldr     x29, [x19, #0x0E8]
    ldr     x17, [x19, #0x100]
    msr     nzcv, x17
    blr     x16
    ldr     x9, [sp, #0xD8]
    str     x0, [x9, #0x000]
    str     x1, [x9, #0x008]
    str     q0, [x9, #0x110]
    mrs     x2, nzcv
    str     x2, [x9, #0x100]
    ldr     x0, [sp, #0xD0]
    bl      _c_resume_all_hooks
    ldp     q8,  q9,  [sp, #0x50]
    ldp     q10, q11, [sp, #0x70]
    ldp     q12, q13, [sp, #0x90]
    ldp     q14, q15, [sp, #0xB0]
    ldp     x19, x20, [sp, #0x00]
    ldp     x21, x22, [sp, #0x10]
    ldp     x23, x24, [sp, #0x20]
    ldp     x25, x26, [sp, #0x30]
    ldp     x27, x28, [sp, #0x40]
    add     sp, sp, #0xE0
    ldp     x29, x30, [sp], #16
    ret

// patch_exec(ctx, patch_fn): restore regs from ctx, jump to patch_fn (must branch to _patch_exec_resume).
_patch_exec:
    stp     x29, x30, [sp, #-16]!
    mov     x29, sp
    sub     sp, sp, #0xE0
    stp     x19, x20, [sp, #0x00]
    stp     x21, x22, [sp, #0x10]
    stp     x23, x24, [sp, #0x20]
    stp     x25, x26, [sp, #0x30]
    stp     x27, x28, [sp, #0x40]
    str     x18,      [sp, #0x50]
    str     x0,       [sp, #0x58]
    stp     q8,  q9,  [sp, #0x60]
    stp     q10, q11, [sp, #0x80]
    stp     q12, q13, [sp, #0xA0]
    stp     q14, q15, [sp, #0xC0]
    mov     x19, x0
    mov     x17, x1
    ldr     x16, [x19, #0x100]
    msr     nzcv, x16
    ldp     q0,  q1,  [x19, #0x110]
    ldp     q2,  q3,  [x19, #0x130]
    ldp     q4,  q5,  [x19, #0x150]
    ldp     q6,  q7,  [x19, #0x170]
    ldp     q8,  q9,  [x19, #0x190]
    ldp     q10, q11, [x19, #0x1B0]
    ldp     q12, q13, [x19, #0x1D0]
    ldp     q14, q15, [x19, #0x1F0]
    ldp     q16, q17, [x19, #0x210]
    ldp     q18, q19, [x19, #0x230]
    ldp     q20, q21, [x19, #0x250]
    ldp     q22, q23, [x19, #0x270]
    ldp     q24, q25, [x19, #0x290]
    ldp     q26, q27, [x19, #0x2B0]
    ldp     q28, q29, [x19, #0x2D0]
    ldp     q30, q31, [x19, #0x2F0]
    ldp     x0,  x1,  [x19, #0x000]
    ldp     x2,  x3,  [x19, #0x010]
    ldp     x4,  x5,  [x19, #0x020]
    ldp     x6,  x7,  [x19, #0x030]
    ldp     x8,  x9,  [x19, #0x040]
    ldp     x10, x11, [x19, #0x050]
    ldp     x12, x13, [x19, #0x060]
    ldp     x14, x15, [x19, #0x070]
    ldr     x16, [x19, #0x080]
    ldr     x18, [x19, #0x090]
    ldp     x20, x21, [x19, #0x0A0]
    ldp     x22, x23, [x19, #0x0B0]
    ldp     x24, x25, [x19, #0x0C0]
    ldp     x26, x27, [x19, #0x0D0]
    ldr     x28, [x19, #0x0E0]
    ldr     x29, [x19, #0x0E8]
    ldr     x30, [x19, #0x0F0]
    ldr     x19, [x19, #0x098]
    br      x17

// patch_exec_resume: write regs back to ctx, restore callee-saved, return to patch_exec caller.
_patch_exec_resume:
    ldr     x17, [sp, #0x58]
    stp     q0,  q1,  [x17, #0x110]
    stp     q2,  q3,  [x17, #0x130]
    stp     q4,  q5,  [x17, #0x150]
    stp     q6,  q7,  [x17, #0x170]
    stp     q8,  q9,  [x17, #0x190]
    stp     q10, q11, [x17, #0x1B0]
    stp     q12, q13, [x17, #0x1D0]
    stp     q14, q15, [x17, #0x1F0]
    stp     q16, q17, [x17, #0x210]
    stp     q18, q19, [x17, #0x230]
    stp     q20, q21, [x17, #0x250]
    stp     q22, q23, [x17, #0x270]
    stp     q24, q25, [x17, #0x290]
    stp     q26, q27, [x17, #0x2B0]
    stp     q28, q29, [x17, #0x2D0]
    stp     q30, q31, [x17, #0x2F0]
    stp     x0,  x1,  [x17, #0x000]
    stp     x2,  x3,  [x17, #0x010]
    stp     x4,  x5,  [x17, #0x020]
    stp     x6,  x7,  [x17, #0x030]
    stp     x8,  x9,  [x17, #0x040]
    stp     x10, x11, [x17, #0x050]
    stp     x12, x13, [x17, #0x060]
    stp     x14, x15, [x17, #0x070]
    str     x16, [x17, #0x080]
    str     x18, [x17, #0x090]
    str     x19, [x17, #0x098]
    stp     x20, x21, [x17, #0x0A0]
    stp     x22, x23, [x17, #0x0B0]
    stp     x24, x25, [x17, #0x0C0]
    stp     x26, x27, [x17, #0x0D0]
    str     x28, [x17, #0x0E0]
    str     x29, [x17, #0x0E8]
    str     x30, [x17, #0x0F0]
    mrs     x16, nzcv
    str     x16, [x17, #0x100]
    ldp     q8,  q9,  [sp, #0x60]
    ldp     q10, q11, [sp, #0x80]
    ldp     q12, q13, [sp, #0xA0]
    ldp     q14, q15, [sp, #0xC0]
    ldp     x19, x20, [sp, #0x00]
    ldp     x21, x22, [sp, #0x10]
    ldp     x23, x24, [sp, #0x20]
    ldp     x25, x26, [sp, #0x30]
    ldp     x27, x28, [sp, #0x40]
    ldr     x18,      [sp, #0x50]
    add     sp, sp, #0xE0
    ldp     x29, x30, [sp], #16
    ret
